name: Build IMM for N1-C

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  CONFIG_FILE: N1/.config
  DIY_SH: N1/diy.sh
  FILES: N1/files
  TZ: Asia/Shanghai
  CCACHE_DIR: /tmp/ccache
  UPLOAD_WETRANSFER: false

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: æ£€æŸ¥æœåŠ¡å™¨é…ç½®
      run: |
        echo "ğŸ–¥ï¸ CPUä¿¡æ¯"
        echo "ç‰©ç†CPUæ•°é‡: $(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
        echo "CPUæ ¸å¿ƒä¿¡æ¯: $(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c)"
        echo "ğŸ’¾ å†…å­˜ä¿¡æ¯"
        sudo lshw -short -C memory | grep GiB
        echo "ğŸ’½ ç£ç›˜ä¿¡æ¯"
        df -Th

    - name: æ¸…ç†ç³»ç»Ÿç©ºé—´
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 8192
        swap-size-mb: 1024
        temp-reserve-mb: 1024
        remove-dotnet: true
        remove-android: true
        remove-haskell: true
        remove-docker-images: true
        # ç§»é™¤æ›´å¤šä¸éœ€è¦çš„å†…å®¹
        remove-codeql: true
        remove-large-packages: true

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    # ä½¿ç”¨æ”¹è¿›çš„ç¼“å­˜ç­–ç•¥
    - name: ç¼“å­˜ç¼–è¯‘
      uses: stupidloud/cachewrtbuild@main
      with:
        ccache: true
        mixkey: N1-${{ env.REPO_BRANCH }}-${{ github.sha }}
        prefix: ${{ github.workspace }}/openwrt
        ccache-size: 15G  # å¢åŠ ç¼“å­˜å¤§å°
        
    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update -y
        # å®‰è£…å¿…è¦çš„ç¼–è¯‘å·¥å…·å’Œä¾èµ–
        sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
        bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
        git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
        libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
        mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools \
        libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
        vim wget xmlto xxd zlib1g-dev
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo chown -R $USER:$GROUPS $GITHUB_WORKSPACE
        
        # é…ç½®ccache
        ccache -M 15G
        ccache -o compression=true
        ccache -o compression_level=9

    - name: å…‹éš†æºä»£ç 
      run: |
        df -hT $PWD
        git clone $REPO_URL -b $REPO_BRANCH openwrt --depth=1
        cd openwrt
        echo "WORKDIR=$PWD" >> $GITHUB_ENV
        
    - name: æ›´æ–°å¹¶å®‰è£…feeds
      working-directory: ./openwrt
      run: |
        echo "å½“å‰ç›®å½•: $PWD"
        # ä¼˜åŒ–feedsæ›´æ–°è¿‡ç¨‹
        ./scripts/feeds update -a -f
        ./scripts/feeds install -a -f
        # å¼€å¯å¤šçº¿ç¨‹ç¼–è¯‘
        sed -i 's/jobs:=1/jobs:=$(nproc)/g' include/host-build.mk
        sed -i 's/jobs:=1/jobs:=$(nproc)/g' include/package.mk

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        [ -e $FILES ] && mv $FILES openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_SH
        # å¯ç”¨ccache
        echo 'CONFIG_CCACHE=y' >> .config

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      working-directory: ./openwrt
      id: package
      run: |
        make defconfig
        make download -j16 || make download -j8 V=s
        find dl -size -1024c -exec rm -f {} \;
        
    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "å¼€å§‹ç¼–è¯‘..."
        make -j$(($(nproc) + 1)) || make -j$(($(nproc)/2)) || make -j1 V=s
        echo "compile_status=success" >> $GITHUB_ENV
        
        # è¾“å‡ºç¼–è¯‘ç»“æœç»Ÿè®¡
        echo "===== ç¼–è¯‘ç»“æœç»Ÿè®¡ ====="
        echo "å·²ç¼–è¯‘çš„åŒ…æ•°é‡: $(find bin/packages/ -type f -name '*.ipk' | wc -l)"
        echo "å›ºä»¶å¤§å°: $(du -h bin/targets/*/*/*.tar.gz 2>/dev/null | awk '{print $1}')"
        echo "å¯ç”¨ç£ç›˜ç©ºé—´: $(df -h | grep '/dev/root' | awk '{print $4}')"
        echo "ccache ç»Ÿè®¡:"
        ccache -s

    - name: æ‰“åŒ…å›ºä»¶
      if: ${{ env.compile_status }} == 'success' && !cancelled()
      uses: unifreq/openwrt_packit@master
      env:
        OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/immortalwrt-armsr-armv8-generic-rootfs.tar.gz
        KERNEL_VERSION_NAME: 6.6.60
        KERNEL_AUTO_LATEST: true
        PACKAGE_SOC: s905d
        WHOAMI: xunmoo
        SW_FLOWOFFLOAD: 0
        SFE_FLOW: 0

    - name: å‘å¸ƒå›ºä»¶
      uses: ncipollo/release-action@main
      if: ${{ env.PACKAGED_STATUS == 'success' }} && !cancelled()
      with:
        tag: immortalwrt_N1_${{ env.PACKAGED_OUTPUTDATE }}
        artifacts: /opt/openwrt_packit/output/*
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
        body: |
          åŸºäºimmortalwrt openwrtæ„å»º
          æ„å»ºæ—¶é—´: ${{ env.PACKAGED_OUTPUTDATE }}
          
          ğŸ“¥ é¦–æ¬¡ä½¿ç”¨å»ºè®®å…¨æ–°åˆ·å†™
          
          ğŸ“Œ åŸºæœ¬ä¿¡æ¯:
          - IP: 192.168.50.3
          - è´¦æˆ·: root
          - å¯†ç : password

    - name: æ¸…ç†æ—§ç‰ˆæœ¬
      uses: dev-drprasad/delete-older-releases@master
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        keep_latest: 5
        delete_tags: true
